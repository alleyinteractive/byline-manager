- pipeline: "Update Built Branch"
  on: "EVENT"
  events:
  - type: "PUSH"
    refs:
    - "refs/heads/production"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
  - action: "npm ci"
    type: "BUILD"
    working_directory: "/buddy/byline-manager"
    docker_image_name: "library/node"
    docker_image_tag: "16"
    execute_commands:
    - "npm ci --cache .npm"
    volume_mappings:
    - "/:/buddy/byline-manager"
    cache_base_image: true
    shell: "BASH"
  - action: "npm test"
    type: "BUILD"
    working_directory: "/buddy/byline-manager"
    docker_image_name: "library/node"
    docker_image_tag: "16"
    execute_commands:
    - "npm test"
    volume_mappings:
    - "/:/buddy/byline-manager"
    cache_base_image: true
    shell: "BASH"
    run_next_parallel: true
  - action: "npm run build"
    type: "BUILD"
    working_directory: "/buddy/byline-manager"
    docker_image_name: "library/node"
    docker_image_tag: "16"
    execute_commands:
    - "npm run build"
    volume_mappings:
    - "/:/buddy/byline-manager"
    cache_base_image: true
    shell: "BASH"
  - action: "Push to built branch"
    type: "BUILD"
    working_directory: "/buddy/byline-manager"
    docker_image_name: "alleyops/ci-resources"
    docker_image_tag: "7.4-fpm-wp"
    execute_commands:
    - "# Git/SSH Configuration"
    - "echo \""
    - "Host github.com"
    - "    StrictHostKeyChecking no"
    - "\" >> ~/.ssh/config"
    - ""
    - "COMMIT_AUTHOR=$(git log -n1 --pretty=format:\"%an <%ae>\")"
    - ""
    - "git config --global user.email \"ops+buddy@alley.co\""
    - "git config --global user.name \"Alley Operations\""
    - "git config --global push.default simple"
    - ""
    - "cd \"$SOURCE_REPO_DIR\""
    - ""
    - "echo \"Cloning built over to $BUILT_BRANCH_DIR\""
    - "git clone --recursive --quiet -b built git@github.com:alleyinteractive/byline-manager.git $BUILT_BRANCH_DIR"
    - ""
    - "cd $BUILT_BRANCH_DIR"
    - "git checkout built"
    - ""
    - "rsync -aq \\"
    - "    --exclude \".git\" \\"
    - "    --exclude \".gitmodules\" \\"
    - "    --exclude \".revision\" \\"
    - "    --exclude \".deployment-state\" \\"
    - "    --exclude bin/ \\"
    - "    --exclude buddy/ \\"
    - "    --exclude tests/ \\"
    - "    --exclude node_modules/ \\"
    - "    --exclude no-vip/ \\"
    - "    \"${SOURCE_REPO_DIR}\" \"${BUILT_BRANCH_DIR}\" --delete"
    - ""
    - "cat << EOF > /tmp/commit.message"
    - "$BUDDY_EXECUTION_REVISION_MESSAGE"
    - "EOF"
    - ""
    - "cd $BUILT_BRANCH_DIR"
    - ""
    - "echo \"Replacing build folder exclusion with .npm in .gitignore\""
    - "sed -i \"s/.*\\/build\\/.*/.npm/\" .gitignore"
    - ""
    - "git add -A"
    - "git status"
    - "git commit --allow-empty -a --author=\"${COMMIT_AUTHOR}\" --file=/tmp/commit.message"
    - ""
    - "echo \"Pushing to byline-manager built\""
    - "git push -u origin"
    - ""
    - "echo \"Done\""
    volume_mappings:
    - "/:/buddy/byline-manager"
    cache_base_image: true
    shell: "BASH"
    variables:
    - key: "BUILT_BRANCH_DIR"
      value: "/tmp/built/"
      type: "VAR"
    - key: "SOURCE_REPO_DIR"
      value: "/buddy/byline-manager/"
      type: "VAR"
